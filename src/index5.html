<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" id="viewport" content="initial-scale=1.0, minimum-scale=1.0, shrink-to-fit=no">
  <meta name="apple-mobile-web-app-capable" content="YES">
  <link rel="stylesheet" type="text/css" href="./cal-heatmap.css">
  <link rel="stylesheet" type="text/css" href="./index.css">
  <title>Cal Heatmap</title>
  <script src="./moment.min.js" charset="utf-8"></script>
  <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="./cal-heatmap.min.js"></script>

  <!-- <script src="./moment.min.js" charset="utf-8"></script>
    <script src="./d3.v4.min.js" charset="utf-8"></script>
    <link rel="stylesheet" type="text/css" href="./calendar-heatmap.css"> -->
  <!-- <script src="./calendar-heatmap.js"></script> -->
</head>

<body>
  <div id="cal-heatmap-container"></div>
  <!-- <script src="./moment.min.js" charset="utf-8"></script>
    <script src="./d3.v4.min.js" charset="utf-8"></script>
    <script src="./calendar-heatmap.js"></script> -->
  <script type="text/javascript">
    function averageCount(arr) {
      var sum = 0;
      arr.sort(function (a, b) {
        return a - b
      });
      arr.pop();
      arr.shift();
      for (var i = 0; i < arr.length; i++) {
        sum += arr[i];
      }
      return sum / arr.length;
    }

    function init(data) {
      // var chartData = [{
      //   date: new Date(),
      //   count: Number
      // }];

      var now = moment().endOf('day').toDate();
      var yearAgo = moment().startOf('day').subtract(1, 'year').toDate();
      var chartData = d3.timeDays(yearAgo, now).map(function (dateElement) {
        return {
          date: dateElement,
          count: (dateElement.getDay() !== 0 && dateElement.getDay() !== 6) ? Math.floor(Math.random() * 60) : Math
            .floor(Math.random() * 10)
        };
      });

      // console.log(chartData);

      var dataObj = JSON.parse(data);
      var firstDate = new Date(0);
      var lastDate = new Date(0);
      var finalDataObj = [];

      for (var i = 0; i < dataObj.length; i++) {
        var dataItem = dataObj[i];
        if (i == 0) {
          firstDate.setUTCSeconds(dataItem.epoch);
        } else if (i == dataObj.length - 1) {
          lastDate.setUTCSeconds(dataItem.epoch);
        }
        var thisDate = new Date(0);
        thisDate.setUTCSeconds(dataItem.epoch);
        finalDataObj.push({
          date: thisDate,
          count: dataItem.count
        });
        // if (countArray.indexOf(dataItem.count) === -1) {
        //   countArray.push(dataItem.count)
        // }
      }

      var localObj = {
        months: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        days: ['S', 'M', 'T', 'W', 'T', 'F', 'S'],
        No: 'No',
        on: 'on',
        Less: 'Less',
        More: 'More'
      }

      var chart1 = calendarHeatmap()
        .data(finalDataObj)
        .selector('#cal-heatmap')
        .colorRange(['#D8E6E7', '#218380'])
        .tooltipEnabled(true)
        .legendEnabled(true)
        .onClick(function (data) {
          console.log('onClick callback. Data:', data);
        });
      chart1();
    }

    // init('[{"epoch":"1516665600","count":4},{"epoch":"1516924800","count":8},{"epoch":"1521936000","count":1},{"epoch":"1523836800","count":14},{"epoch":"1525564800","count":3},{"epoch":"1526342400","count":1},{"epoch":"1527724800","count":1},{"epoch":"1532476800","count":20},{"epoch":"1533513600","count":12},{"epoch":"1533686400","count":31},{"epoch":"1535328000","count":9},{"epoch":"1537401600","count":5},{"epoch":"1538006400","count":23},{"epoch":"1538092800","count":23},{"epoch":"1538179200","count":28},{"epoch":"1538265600","count":40},{"epoch":"1538956800","count":47},{"epoch":"1539043200","count":9},{"epoch":"1539216000","count":6},{"epoch":"1539302400","count":3},{"epoch":"1539820800","count":23},{"epoch":"1539907200","count":1},{"epoch":"1540857600","count":73},{"epoch":"1540944000","count":15},{"epoch":"1541030400","count":1},{"epoch":"1541116800","count":3},{"epoch":"1541203200","count":1},{"epoch":"1541462400","count":1},{"epoch":"1542067200","count":9},{"epoch":"1542153600","count":13},{"epoch":"1542499200","count":4},{"epoch":"1542672000","count":2},{"epoch":"1542931200","count":3},{"epoch":"1543190400","count":3},{"epoch":"1543968000","count":1},{"epoch":"1544313600","count":182},{"epoch":"1544400000","count":13},{"epoch":"1545091200","count":17},{"epoch":"1545177600","count":5},{"epoch":"1545264000","count":10},{"epoch":"1552262400","count":21},{"epoch":"1557187200","count":30},{"epoch":"1560124800","count":1}]');

    function init1(data) {
      var dataObj = JSON.parse(data);
      var finalDataObj = {};
      var firstDate = new Date(0);
      var lastDate = new Date(0);
      var countArray = [];
      // 按照规定格式给予数据
      for (var i = 0; i < dataObj.length; i++) {
        var dataItem = dataObj[i];
        if (i == 0) {
          firstDate.setUTCSeconds(dataItem.epoch);
        } else if (i == dataObj.length - 1) {
          lastDate.setUTCSeconds(dataItem.epoch);
        }
        finalDataObj[dataItem.epoch] = dataItem.count;
        if (countArray.indexOf(dataItem.count) === -1) {
          countArray.push(dataItem.count)
        }
      }

      var firstYear = firstDate.getFullYear();
      var lastYear = lastDate.getFullYear();

      // 去掉最高分，去掉最低分，然后计算平均值
      var middleAverage = averageCount(countArray);
      var q1 = middleAverage / 2;
      var q2 = middleAverage;
      var q3 = middleAverage * 2;

      var cal = new CalHeatMap();
      cal.init({
        itemSelector: "#cal-heatmap-container",
        label: {
          // position: "top",
          rotate: "left",
          align: "left",
          offset: {
            x: 5,
            y: 5,
          }
        },
        legendColors: {
          min: "#8AD9FE",
          max: "#1B52B3",
          empty: "#F0F0F0",
        },
        range: lastYear - firstYear + 1,
        // colLimit: 5,
        rowLimit: 7,
        start: firstDate,
        data: finalDataObj,
        domain: "year",
        // domainLabelFormat: "%m",
        // highlight: ["now", dt],
        domainLabelFormat: "",
        subDomain: "day",
        cellSize: 14,
        cellRadius: 3,
        cellPadding: 5,
        domainDynamicDimension: true,
        displayLegend: true,
        legend: [q1, q2, q3],
        // subDomainTextFormat: "%d",
        subDomainTextFormat: "",
        itemName: "",
        // nextSelector: "#domainDynamicDimension-next",
        // previousSelector: "#domainDynamicDimension-previous"
      });
      cal.options.range = 1;
      var containers = document.getElementsByClassName("cal-heatmap-container");
      var calMap = containers[0];
      document.getElementById("cal-heatmap").style.width = calMap.style.width;
    }

    function getClientHeight() {
      // return 200;
      var containers = document.getElementsByClassName("cal-heatmap-container");
      var calMap = containers[0];
      return calMap.getBBox().height;
    }
  </script>
</body>

</html>